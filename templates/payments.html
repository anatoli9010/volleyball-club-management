{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
        <h2 class="mb-2">üí≥ –ü–ª–∞—â–∞–Ω–∏—è</h2>
        <div class="d-flex flex-wrap gap-2">
            <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="üîç –¢—ä—Ä—Å–∏ –ø–æ –∏–º–µ...">
            <a href="{{ url_for('remind_all_payments') }}" class="btn btn-warning btn-sm">
                üîî –ù–∞–ø–æ–º–Ω–∏ –Ω–∞ –≤—Å–∏—á–∫–∏
            </a>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle" id="paymentsTable">
            <thead class="table-dark">
                <tr>
                    <th>–ò–º–µ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–°—É–º–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    <td>{{ row.player.full_name }}</td>
                    <td>
                        {% if row.payment.status == 'paid' %}
                            <span class="badge bg-success">–ü–ª–∞—Ç–µ–Ω–æ</span>
                        {% else %}
                            <span class="badge bg-danger">–ù–µ–ø–ª–∞—Ç–µ–Ω–æ</span>
                        {% endif %}
                    </td>
                    <td>{{ row.payment.amount or 0 }} –ª–≤.</td>
                    <td>
                        <!-- –û—Ç–±–µ–ª—è–∑–≤–∞–Ω–µ –∫–∞—Ç–æ –ø–ª–∞—Ç–µ–Ω–æ -->
                        <button class="btn btn-success btn-sm" onclick="openPayModal({{ row.player.id }})">üí≤ –ü–ª–∞—Ç–∏</button>

                        <!-- –ò—Å—Ç–æ—Ä–∏—è -->
                        <button class="btn btn-info btn-sm" onclick="openHistoryModal({{ row.player.id }})">üìú –ò—Å—Ç–æ—Ä–∏—è</button>

                        <!-- –ù–∞–ø–æ–º–Ω—è–Ω–µ -->
                        <a href="{{ url_for('remind_payment', payment_id=row.payment.id) }}" 
                           class="btn btn-warning btn-sm">üîî –ù–∞–ø–æ–º–Ω–∏</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª –∑–∞ –ø–ª–∞—â–∞–Ω–µ -->
<div class="modal fade" id="payModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('add_payment') }}">
        <div class="modal-header">
          <h5 class="modal-title">–û—Ç–±–µ–ª—è–∑–≤–∞–Ω–µ –Ω–∞ –ø–ª–∞—â–∞–Ω–µ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="player_id" id="pay_player_id">
          <div class="mb-3">
            <label>–ú–µ—Å–µ—Ü</label>
            <input type="number" name="month" class="form-control" min="1" max="12" required>
          </div>
          <div class="mb-3">
            <label>–ì–æ–¥–∏–Ω–∞</label>
            <input type="number" name="year" class="form-control" min="2000" required>
          </div>
          <div class="mb-3">
            <label>–°—É–º–∞</label>
            <input type="number" step="0.01" name="amount" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary">–ó–∞–ø–∏—à–∏</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª –∑–∞ –∏—Å—Ç–æ—Ä–∏—è -->
<div class="modal fade" id="historyModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –ø–ª–∞—â–∞–Ω–∏—è—Ç–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>–ú–µ—Å–µ—Ü</th>
              <th>–ì–æ–¥–∏–Ω–∞</th>
              <th>–°—É–º–∞</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
function openPayModal(playerId) {
    document.getElementById('pay_player_id').value = playerId;
    new bootstrap.Modal(document.getElementById('payModal')).show();
}

function openHistoryModal(playerId) {
    fetch(`/api/player/${playerId}/payments`)
    .then(res => res.json())
    .then(data => {
        let tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '';
        data.forEach(row => {
            tbody.innerHTML += `<tr>
                <td>${row.month}</td>
                <td>${row.year}</td>
                <td>${row.amount} –ª–≤.</td>
                <td>${row.paid ? '‚úÖ –ü–ª–∞—Ç–µ–Ω–æ' : '‚ùå –ù–µ–ø–ª–∞—Ç–µ–Ω–æ'}</td>
            </tr>`;
        });
        new bootstrap.Modal(document.getElementById('historyModal')).show();
    });
}

document.getElementById('searchInput').addEventListener('keyup', function () {
    let value = this.value.toLowerCase();
    document.querySelectorAll("#paymentsTable tbody tr").forEach(function (row) {
        row.style.display = row.innerText.toLowerCase().includes(value) ? "" : "none";
    });
});
</script>
{% endblock %}
